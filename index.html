<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‚ú® Fantasy Mage AR V8 - Best Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #0d001a 100%);
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        /* Main Menu */
        #mainMenu {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 50%, #0d0619 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .game-title {
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 0 0 20px #ff6b00, 0 0 40px #ff6b00;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .game-subtitle {
            font-size: 1.2em;
            color: #b388ff;
            margin-bottom: 30px;
        }
        
        .currency-display {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid;
        }
        
        .gold-display { border-color: #ffd700; color: #ffd700; }
        .gem-display { border-color: #e040fb; color: #e040fb; }
        
        .menu-btn {
            width: 280px;
            padding: 18px;
            margin: 8px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .btn-adventure {
            background: linear-gradient(135deg, #ff6b00 0%, #ff9500 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(255,107,0,0.5);
        }
        
        .btn-tower {
            background: linear-gradient(135deg, #7c4dff 0%, #b388ff 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(124,77,255,0.5);
        }
        
        .btn-pets {
            background: linear-gradient(135deg, #00bcd4 0%, #4dd0e1 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(0,188,212,0.5);
        }
        
        .btn-inventory {
            background: linear-gradient(135deg, #8d6e63 0%, #a1887f 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(141,110,99,0.5);
        }
        
        .btn-shop {
            background: linear-gradient(135deg, #ffd700 0%, #ffeb3b 100%);
            color: #333;
            box-shadow: 0 5px 20px rgba(255,215,0,0.5);
        }
        
        .btn-stats {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(26,35,126,0.5);
        }
        
        .btn-skills {
            background: linear-gradient(135deg, #e040fb 0%, #ea80fc 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(224,64,251,0.5);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #607d8b 0%, #90a4ae 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(96,125,139,0.5);
        }
        
        .btn-petcare {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(250,112,154,0.5);
        }
        
        .btn-dungeon {
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(139,92,246,0.5);
        }
        
        .menu-btn:active {
            transform: scale(0.95);
        }
        
        /* Player Stats Display */
        .player-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .stat-box {
            background: rgba(0,0,0,0.6);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 80px;
        }
        
        .stat-label { color: #888; font-size: 0.8em; }
        .stat-value { color: #fff; font-size: 1.2em; font-weight: bold; }
        
        /* Game Screen */
        #gameScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
            z-index: 100;
        }
        
        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* HUD */
        #hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 15px;
            z-index: 200;
        }
        
        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .hud-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Player HP Bar */
        .player-hp-container {
            width: 200px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 5px;
        }
        
        .player-hp-bar {
            height: 20px;
            background: linear-gradient(90deg, #f44336, #ff5722);
            border-radius: 8px;
            transition: width 0.3s;
            position: relative;
        }
        
        .player-hp-text {
            position: absolute;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            line-height: 20px;
            text-shadow: 1px 1px 2px black;
        }
        
        /* MP Bar */
        .player-mp-container {
            width: 200px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 5px;
        }
        
        .player-mp-bar {
            height: 15px;
            background: linear-gradient(90deg, #2196f3, #03a9f4);
            border-radius: 8px;
            transition: width 0.3s;
        }
        
        .hud-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .wave-display {
            background: rgba(124,77,255,0.8);
            padding: 8px 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
        }
        
        .floor-display {
            background: rgba(255,107,0,0.8);
            padding: 8px 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
        }
        
        .score-display {
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 10px;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Currency HUD */
        .hud-currency {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .hud-gold, .hud-gem {
            background: rgba(0,0,0,0.7);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .hud-gold { color: #ffd700; }
        .hud-gem { color: #e040fb; }
        
        /* Staff Display */
        #staffDisplay {
            position: absolute;
            bottom: 120px;
            left: 20px;
            width: 80px;
            height: 160px;
            z-index: 200;
            transform: rotate(-20deg);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }
        
        #staffDisplay img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Skill Buttons */
        #skillBar {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 200;
        }
        
        .skill-btn {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            border: 3px solid;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .skill-btn.fire { border-color: #ff5722; }
        .skill-btn.water { border-color: #2196f3; }
        .skill-btn.earth { border-color: #8d6e63; }
        .skill-btn.wind { border-color: #4caf50; }
        .skill-btn.light { border-color: #ffc107; }
        .skill-btn.dark { border-color: #9c27b0; }
        
        .skill-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }
        
        .skill-btn.on-cooldown {
            opacity: 0.5;
        }
        
        .skill-icon {
            font-size: 1.5em;
        }
        
        .skill-name {
            font-size: 0.6em;
            color: white;
        }
        
        .cooldown-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            display: none;
        }
        
        /* Action Buttons */
        #actionButtons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 200;
        }
        
        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-cast {
            background: linear-gradient(135deg, #7c4dff 0%, #b388ff 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(124,77,255,0.5);
        }
        
        .btn-capture {
            background: linear-gradient(135deg, #ff6b00 0%, #ff9500 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(255,107,0,0.5);
            display: none;
        }
        
        .btn-capture.show {
            display: flex;
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        /* Capture Popup */
        #capturePopup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255,107,0,0.95), rgba(255,149,0,0.95));
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 300;
            display: none;
            animation: bounceIn 0.5s;
        }
        
        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        #capturePopup h2 {
            color: white;
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        #capturePopup .monster-name {
            color: #fff3e0;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        
        #capturePopup button {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            background: white;
            color: #ff6b00;
            cursor: pointer;
            animation: pulse 0.5s infinite alternate;
        }
        
        /* Radar */
        #radar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: 3px solid #7c4dff;
            z-index: 200;
        }
        
        #radarCanvas {
            width: 100%;
            height: 100%;
        }
        
        /* Exit Button */
        #exitBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 200;
        }
        
        /* Damage Indicator */
        .damage-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 250;
            display: none;
        }
        
        .damage-flash {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,0,0,0.3);
            pointer-events: none;
            z-index: 240;
            display: none;
        }
        
        /* Spell Effects */
        .spell-effect {
            position: absolute;
            pointer-events: none;
            z-index: 220;
        }
        
        /* Inventory Screen */
        #statsScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        #inventoryScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .inventory-title {
            color: #ffd700;
            font-size: 1.8em;
        }
        
        .inventory-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .inv-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }
        
        .inv-tab.active {
            background: #7c4dff;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }
        
        .inv-slot {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .inv-slot:hover {
            border-color: #7c4dff;
            transform: scale(1.05);
        }
        
        .inv-slot.equipped {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .inv-slot img {
            width: 60%;
            height: 60%;
            object-fit: contain;
        }
        
        .inv-slot .item-name {
            color: white;
            font-size: 0.7em;
            text-align: center;
            margin-top: 5px;
        }
        
        .inv-slot .item-rarity {
            font-size: 0.6em;
            padding: 2px 6px;
            border-radius: 5px;
        }
        
        .rarity-common { background: #9e9e9e; color: white; }
        .rarity-rare { background: #2196f3; color: white; }
        .rarity-epic { background: #9c27b0; color: white; }
        .rarity-legendary { background: #ff9800; color: white; }
        
        /* Staff Selection */
        #staffSelectScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1100;
            display: none;
            padding: 20px;
            overflow-y: auto;
        }
        
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .staff-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .staff-card:hover {
            border-color: #7c4dff;
        }
        
        .staff-card.equipped {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .staff-card img {
            width: 80px;
            height: 150px;
            object-fit: contain;
        }
        
        .staff-card .staff-name {
            color: white;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .staff-card .staff-stats {
            color: #b388ff;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        /* Shop Screen */
        #shopScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .shop-section {
            margin-bottom: 30px;
        }
        
        .shop-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .shop-item {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.2);
        }
        
        .shop-item .item-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .shop-item .item-name {
            color: white;
            font-weight: bold;
        }
        
        .shop-item .item-price {
            margin-top: 10px;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .price-gold {
            background: rgba(255,215,0,0.3);
            color: #ffd700;
        }
        
        .price-gem {
            background: rgba(224,64,251,0.3);
            color: #e040fb;
        }
        
        /* Skills Screen */
        #skillsScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .element-section {
            margin-bottom: 30px;
        }
        
        .element-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .element-icon {
            font-size: 1.5em;
        }
        
        .element-name {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .skills-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .skill-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .skill-card.unlocked {
            border-color: rgba(255,255,255,0.3);
        }
        
        .skill-card.locked {
            opacity: 0.5;
        }
        
        .skill-card.equipped {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .skill-card .skill-icon {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .skill-card .skill-name {
            color: white;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .skill-card .skill-unlock {
            color: #888;
            font-size: 0.7em;
            margin-top: 5px;
        }
        
        .skill-card .skill-dmg {
            color: #ff5722;
            font-size: 0.75em;
            margin-top: 3px;
        }
        
        /* Settings Screen */
        #settingsScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .settings-group {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-group h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .setting-item label {
            color: white;
        }
        
        .setting-item input[type="range"] {
            width: 150px;
        }
        
        .setting-value {
            color: #b388ff;
            min-width: 50px;
            text-align: right;
        }
        
        /* Close Button */
        .close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
        }
        
        /* Game Over Screen */
        #gameOverScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 500;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .game-over-title {
            font-size: 3em;
            color: #f44336;
            text-shadow: 0 0 20px #f44336;
            margin-bottom: 20px;
        }
        
        .game-over-stats {
            color: white;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .game-over-stats div {
            margin: 10px 0;
            font-size: 1.2em;
        }
        
        /* Pets Screen */
        #petCareScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        #dungeonScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .dungeon-card {
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dungeon-card:hover {
            transform: scale(1.02);
        }
        
        .dungeon-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .dungeon-icon {
            font-size: 2.5em;
        }
        
        .dungeon-info {
            flex: 1;
        }
        
        .dungeon-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        
        .dungeon-desc {
            color: #666;
            font-size: 0.9em;
        }
        
        .dungeon-reward {
            color: #8B5CF6;
            font-size: 0.85em;
        }
        
        #petsScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .pet-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .pet-card:hover {
            border-color: #7c4dff;
        }
        
        .pet-card.selected {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }
        
        .pet-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        .pet-card .pet-name {
            color: white;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .pet-card .pet-element {
            font-size: 0.8em;
            margin-top: 3px;
        }
        
        .pet-card .pet-level {
            color: #b388ff;
            font-size: 0.8em;
        }
        
        /* Tower Screen */
        #towerScreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #2d1b4e 0%, #1a0d2e 100%);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        
        .tower-floors {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .tower-floor {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tower-floor:hover {
            border-color: #7c4dff;
        }
        
        .tower-floor.cleared {
            background: rgba(76,175,80,0.3);
            border-color: #4caf50;
        }
        
        .tower-floor.current {
            border-color: #ffd700;
            animation: pulse 1s infinite alternate;
        }
        
        .tower-floor.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .floor-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .floor-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .floor-element {
            font-size: 1.5em;
        }
        
        .floor-name {
            color: white;
        }
        
        .floor-reward {
            color: #b388ff;
            font-size: 0.9em;
        }
        
        /* Element Advantage Display */
        .element-advantage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 250;
            display: none;
            animation: fadeInOut 1.5s forwards;
        }
        
        .advantage-super {
            background: rgba(76,175,80,0.9);
            color: white;
        }
        
        .advantage-weak {
            background: rgba(244,67,54,0.9);
            color: white;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* Gold Drop Animation */
        .gold-drop {
            position: absolute;
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2em;
            pointer-events: none;
            animation: goldFloat 1s forwards;
            z-index: 230;
        }
        
        @keyframes goldFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        /* Level Up Popup */
        #levelUpPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(124,77,255,0.95), rgba(179,136,255,0.95));
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 600;
            display: none;
            animation: bounceIn 0.5s;
        }
        
        #levelUpPopup h2 {
            color: #ffd700;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        #levelUpPopup .new-level {
            color: white;
            font-size: 3em;
            font-weight: bold;
        }
        
        #levelUpPopup .rewards {
            color: #e1bee7;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="mainMenu">
        <div class="game-title">‚ú® Fantasy Mage</div>
        <div class="game-subtitle">Pet Collection AR</div>
        
        <div class="currency-display">
            <div class="currency-item gold-display">
                <span>ü™ô</span>
                <span id="menuGold">0</span>
            </div>
            <div class="currency-item gem-display">
                <span>üíé</span>
                <span id="menuGems">100</span>
            </div>
        </div>
        
        <div class="player-stats">
            <div class="stat-box">
                <div class="stat-label">LEVEL</div>
                <div class="stat-value" id="menuLevel">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">EXP</div>
                <div class="stat-value" id="menuExp">0/100</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">PETS</div>
                <div class="stat-value" id="menuPets">0</div>
            </div>
        </div>
        
        <button class="menu-btn btn-adventure" onclick="startAdventure()">‚öîÔ∏è ADVENTURE</button>
        <button class="menu-btn btn-tower" onclick="showTower()">üè∞ MAGIC TOWER</button>
        <button class="menu-btn btn-pets" onclick="showPets()">üêæ MY PETS</button>
        <button class="menu-btn btn-petcare" onclick="showPetCare()">ü•ö PET CARE</button>
        <button class="menu-btn btn-inventory" onclick="showInventory()">üéí INVENTORY</button>
        <button class="menu-btn btn-dungeon" onclick="showDungeons()">üóùÔ∏è DUNGEON</button>
        <button class="menu-btn btn-stats" onclick="showStats()">üìä STATS</button>
        <button class="menu-btn btn-skills" onclick="showSkills()">‚ú® SKILLS</button>
        <button class="menu-btn btn-shop" onclick="showShop()">üõí SHOP</button>
        <button class="menu-btn btn-settings" onclick="showSettings()">‚öôÔ∏è SETTINGS</button>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen">
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD -->
        <div id="hud">
            <div class="hud-top">
                <div class="hud-left">
                    <div class="player-hp-container">
                        <div class="player-hp-bar" id="playerHpBar" style="width: 100%">
                            <span class="player-hp-text" id="playerHpText">100/100</span>
                        </div>
                    </div>
                    <div class="player-mp-container">
                        <div class="player-mp-bar" id="playerMpBar" style="width: 100%"></div>
                    </div>
                    <div class="hud-currency">
                        <div class="hud-gold">ü™ô <span id="hudGold">0</span></div>
                        <div class="hud-gem">üíé <span id="hudGems">100</span></div>
                    </div>
                </div>
                <div class="hud-right">
                    <div class="wave-display" id="waveDisplay">Wave 1</div>
                    <div class="floor-display" id="floorDisplay" style="display:none">Floor 1</div>
                    <div class="score-display">Score: <span id="scoreDisplay">0</span></div>
                </div>
            </div>
        </div>
        
        <!-- Staff Display -->
        <div id="staffDisplay">
            <img src="assets/weapons/staff_starter_t.png" id="staffImage">
        </div>
        
        <!-- Skill Bar -->
        <div id="skillBar">
            <!-- Skills will be populated by JS -->
        </div>
        
        <!-- Potion Buttons -->
        <div id="potionButtons" style="position: absolute; bottom: 20px; left: 120px; display: flex; gap: 10px; z-index: 200;">
            <button class="potion-btn" id="hpPotionBtn" onclick="useHPPotion()" style="width: 55px; height: 55px; border-radius: 10px; border: 2px solid #ff4444; background: linear-gradient(135deg, #ff4444, #cc0000); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;">
                <span style="font-size: 1.2em;">‚ù§Ô∏è</span>
                <span id="hpPotionCount" style="font-size: 0.7em;">x5</span>
            </button>
            <button class="potion-btn" id="mpPotionBtn" onclick="useMPPotion()" style="width: 55px; height: 55px; border-radius: 10px; border: 2px solid #4444ff; background: linear-gradient(135deg, #4444ff, #0000cc); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;">
                <span style="font-size: 1.2em;">üíô</span>
                <span id="mpPotionCount" style="font-size: 0.7em;">x5</span>
            </button>
        </div>
        
        <!-- Action Buttons -->
        <div id="actionButtons">
            <button class="action-btn btn-capture" id="captureBtn" onclick="captureMonster()">
                üîÆ<br>CAPTURE
            </button>
            <button class="action-btn btn-cast" onclick="castSpell()">
                ‚ú®<br>CAST
            </button>
        </div>
        
        <!-- Radar -->
        <div id="radar">
            <canvas id="radarCanvas"></canvas>
        </div>
        
        <!-- Exit Button -->
        <button id="exitBtn" onclick="exitGame()">EXIT</button>
        
        <!-- Damage Flash -->
        <div class="damage-flash" id="damageFlash"></div>
        
        <!-- Element Advantage Display -->
        <div class="element-advantage" id="elementAdvantage"></div>
        
        <!-- Capture Popup -->
        <div id="capturePopup">
            <h2>üîÆ CAPTURE!</h2>
            <div class="monster-name" id="captureMonsterName">Flamey</div>
            <button onclick="confirmCapture()">CAPTURE NOW!</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen">
        <div class="game-over-title">GAME OVER</div>
        <div class="game-over-stats">
            <div>Wave Reached: <span id="finalWave">1</span></div>
            <div>Monsters Defeated: <span id="finalKills">0</span></div>
            <div>Gold Earned: <span id="finalGold">0</span></div>
            <div>EXP Earned: <span id="finalExp">0</span></div>
        </div>
        <button class="menu-btn btn-adventure" onclick="returnToMenu()">RETURN TO MENU</button>
    </div>
    
    <!-- Level Up Popup -->
    <div id="levelUpPopup">
        <h2>‚¨ÜÔ∏è LEVEL UP!</h2>
        <div class="new-level" id="newLevel">2</div>
        <div class="rewards">
            +5 Stat Points<br>
            New Skills Unlocked!
        </div>
        <button onclick="closeLevelUp()" style="margin-top: 15px; padding: 10px 30px; background: #ffd700; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">OK</button>
    </div>
    
    <!-- Stats Allocation Screen -->
    <div id="statsScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">üìä Stats</h2>
            <button class="close-btn" onclick="closeStats()">Close</button>
        </div>
        <div style="color: #ffd700; font-size: 1.2em; margin-bottom: 20px;">Available Points: <span id="availablePoints">0</span></div>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <span style="color: #fff;">üí• INT (Magic Damage)</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="statINT" style="color: #ffd700; font-size: 1.3em;">10</span>
                    <button onclick="allocateStat('INT')" style="padding: 5px 15px; background: #7c4dff; color: #fff; border: none; border-radius: 5px; cursor: pointer;">+</button>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <span style="color: #fff;">üìö WIS (Max MP)</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="statWIS" style="color: #ffd700; font-size: 1.3em;">10</span>
                    <button onclick="allocateStat('WIS')" style="padding: 5px 15px; background: #7c4dff; color: #fff; border: none; border-radius: 5px; cursor: pointer;">+</button>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <span style="color: #fff;">‚ù§Ô∏è VIT (Max HP)</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="statVIT" style="color: #ffd700; font-size: 1.3em;">10</span>
                    <button onclick="allocateStat('VIT')" style="padding: 5px 15px; background: #7c4dff; color: #fff; border: none; border-radius: 5px; cursor: pointer;">+</button>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <span style="color: #fff;">‚ö° SPD (Cast Speed)</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="statSPD" style="color: #ffd700; font-size: 1.3em;">10</span>
                    <button onclick="allocateStat('SPD')" style="padding: 5px 15px; background: #7c4dff; color: #fff; border: none; border-radius: 5px; cursor: pointer;">+</button>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <span style="color: #fff;">üçÄ LUK (Capture Rate & Gold)</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="statLUK" style="color: #ffd700; font-size: 1.3em;">10</span>
                    <button onclick="allocateStat('LUK')" style="padding: 5px 15px; background: #7c4dff; color: #fff; border: none; border-radius: 5px; cursor: pointer;">+</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inventory Screen -->
    <div id="inventoryScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">üéí Inventory</h2>
            <button class="close-btn" onclick="closeInventory()">Close</button>
        </div>
        <div class="inventory-tabs">
            <button class="inv-tab active" onclick="showInvTab('weapons')">‚öîÔ∏è Weapons</button>
            <button class="inv-tab" onclick="showInvTab('items')">üß™ Items</button>
            <button class="inv-tab" onclick="showInvTab('materials')">üíé Materials</button>
            <button class="inv-tab" onclick="showInvTab('accessories')">üíç Accessories</button>
        </div>
        <div class="inventory-grid" id="inventoryGrid">
            <!-- Items populated by JS -->
        </div>
    </div>
    
    <!-- Shop Screen -->
    <div id="shopScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">üõí Shop</h2>
            <button class="close-btn" onclick="closeShop()">Close</button>
        </div>
        
        <div class="shop-section">
            <h3>üíé Buy Gems (Premium)</h3>
            <div class="shop-items">
                <div class="shop-item" onclick="buyGems(100)">
                    <div class="item-icon">üíé</div>
                    <div class="item-name">100 Gems</div>
                    <div class="item-price price-gold">‡∏ø35</div>
                </div>
                <div class="shop-item" onclick="buyGems(500)">
                    <div class="item-icon">üíéüíé</div>
                    <div class="item-name">500 Gems</div>
                    <div class="item-price price-gold">‡∏ø150</div>
                </div>
                <div class="shop-item" onclick="buyGems(1200)">
                    <div class="item-icon">üíéüíéüíé</div>
                    <div class="item-name">1200 Gems</div>
                    <div class="item-price price-gold">‡∏ø300</div>
                </div>
            </div>
        </div>
        
        <div class="shop-section">
            <h3>ü™ô Buy with Gold</h3>
            <div class="shop-items">
                <div class="shop-item" onclick="buyItem('mpPotion', 50)">
                    <div class="item-icon">üß™</div>
                    <div class="item-name">MP Potion</div>
                    <div class="item-price price-gold">ü™ô 50</div>
                </div>
                <div class="shop-item" onclick="buyItem('hpPotion', 80)">
                    <div class="item-icon">‚ù§Ô∏è</div>
                    <div class="item-name">HP Potion</div>
                    <div class="item-price price-gold">ü™ô 80</div>
                </div>
                <div class="shop-item" onclick="buyItem('captureOrb', 200)">
                    <div class="item-icon">üîÆ</div>
                    <div class="item-name">Capture Orb</div>
                    <div class="item-price price-gold">ü™ô 200</div>
                </div>
            </div>
        </div>
        
        <div class="shop-section">
            <h3>üíé Buy with Gems</h3>
            <div class="shop-items">
                <div class="shop-item" onclick="buyWithGems('gold1000', 50)">
                    <div class="item-icon">ü™ô</div>
                    <div class="item-name">1000 Gold</div>
                    <div class="item-price price-gem">üíé 50</div>
                </div>
                <div class="shop-item" onclick="buyWithGems('rareEgg', 100)">
                    <div class="item-icon">ü•ö</div>
                    <div class="item-name">Rare Pet Egg</div>
                    <div class="item-price price-gem">üíé 100</div>
                </div>
                <div class="shop-item" onclick="buyWithGems('expBoost', 30)">
                    <div class="item-icon">‚ö°</div>
                    <div class="item-name">2x EXP (1hr)</div>
                    <div class="item-price price-gem">üíé 30</div>
                </div>
                <div class="shop-item" onclick="buyWithGems('goldBoost', 30)">
                    <div class="item-icon">üí∞</div>
                    <div class="item-name">2x Gold (1hr)</div>
                    <div class="item-price price-gem">üíé 30</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Skills Screen -->
    <div id="skillsScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">‚ú® Skills</h2>
            <button class="close-btn" onclick="closeSkills()">Close</button>
        </div>
        <p style="color: #888; margin-bottom: 20px;">Tap to equip skills (max 4). Unlock more by leveling up!</p>
        <div id="skillsList">
            <!-- Skills populated by JS -->
        </div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settingsScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">‚öôÔ∏è Settings</h2>
            <button class="close-btn" onclick="closeSettings()">Close</button>
        </div>
        
        <div class="settings-group">
            <h3>üì∑ Camera</h3>
            <div class="setting-item">
                <label>FOV (Field of View)</label>
                <input type="range" id="fovSlider" min="60" max="120" value="90" onchange="updateFOV()">
                <span class="setting-value" id="fovValue">90¬∞</span>
            </div>
            <div class="setting-item">
                <label>Camera Sensitivity</label>
                <input type="range" id="sensitivitySlider" min="50" max="200" value="100" onchange="updateSensitivity()">
                <span class="setting-value" id="sensitivityValue">1.0x</span>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>üîä Audio</h3>
            <div class="setting-item">
                <label>Sound Effects</label>
                <input type="range" id="sfxSlider" min="0" max="100" value="80" onchange="updateSFX()">
                <span class="setting-value" id="sfxValue">80%</span>
            </div>
            <div class="setting-item">
                <label>Music</label>
                <input type="range" id="musicSlider" min="0" max="100" value="50" onchange="updateMusic()">
                <span class="setting-value" id="musicValue">50%</span>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>‚öîÔ∏è Element Advantage Chart</h3>
            <div style="color: white; line-height: 1.8;">
                üî• Fire ‚Üí üí® Wind (1.5x)<br>
                üí® Wind ‚Üí üåç Earth (1.5x)<br>
                üåç Earth ‚Üí üíß Water (1.5x)<br>
                üíß Water ‚Üí üî• Fire (1.5x)<br>
                ‚ú® Light ‚Üî üåô Dark (1.5x both ways)
            </div>
        </div>
    </div>
    
    <!-- Pet Care Screen (Tamagotchi) -->
    <div id="petCareScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">ü•ö Pet Care</h2>
            <button class="close-btn" onclick="closePetCare()">Close</button>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
            <div id="petCareSelector" style="margin-bottom: 15px; color: #b388ff;">Select a pet to care for</div>
            <div style="width: 150px; height: 150px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 20px 0; position: relative;">
                <img id="petCareImg" src="" style="width: 100px; height: 100px; object-fit: contain;" alt="Pet">
                <div id="petCareMood" style="position: absolute; top: -10px; right: -10px; font-size: 2em;">üòä</div>
            </div>
            <div style="background: rgba(255,255,255,0.9); border-radius: 15px; padding: 20px; width: 100%; max-width: 300px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                    <span>üçñ Hunger</span>
                    <div style="width: 150px; height: 15px; background: #ddd; border-radius: 10px; overflow: hidden;">
                        <div id="hungerFill" style="height: 100%; background: linear-gradient(90deg, #ff9800, #f57c00); width: 100%;"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                    <span>üòä Happiness</span>
                    <div style="width: 150px; height: 15px; background: #ddd; border-radius: 10px; overflow: hidden;">
                        <div id="happinessFill" style="height: 100%; background: linear-gradient(90deg, #e91e63, #c2185b); width: 100%;"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>‚ö° Energy</span>
                    <div style="width: 150px; height: 15px; background: #ddd; border-radius: 10px; overflow: hidden;">
                        <div id="energyFill" style="height: 100%; background: linear-gradient(90deg, #4caf50, #388e3c); width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <button onclick="feedPet()" style="padding: 15px 25px; border: none; border-radius: 15px; background: linear-gradient(135deg, #ff9800, #f57c00); color: #fff; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span>üçñ</span>
                    <span>Feed (10ü™ô)</span>
                </button>
                <button onclick="playWithPet()" style="padding: 15px 25px; border: none; border-radius: 15px; background: linear-gradient(135deg, #e91e63, #c2185b); color: #fff; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span>üéæ</span>
                    <span>Play</span>
                </button>
                <button onclick="restPet()" style="padding: 15px 25px; border: none; border-radius: 15px; background: linear-gradient(135deg, #4caf50, #388e3c); color: #fff; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span>üò¥</span>
                    <span>Rest</span>
                </button>
                <button onclick="trainPet()" style="padding: 15px 25px; border: none; border-radius: 15px; background: linear-gradient(135deg, #2196f3, #1976d2); color: #fff; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span>üí™</span>
                    <span>Train</span>
                </button>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;" id="petCareList"></div>
        </div>
    </div>
    
    <!-- Dungeon Screen -->
    <div id="dungeonScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">üóùÔ∏è Dungeons</h2>
            <button class="close-btn" onclick="closeDungeons()">Close</button>
        </div>
        <p style="color: #b388ff; margin-bottom: 20px;">Farm materials to upgrade your gear!</p>
        <div id="dungeonList" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Dungeons populated by JS -->
        </div>
    </div>
    
    <!-- Pets Screen -->
    <div id="petsScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">üêæ My Pets</h2>
            <button class="close-btn" onclick="closePets()">Close</button>
        </div>
        <p style="color: #888; margin-bottom: 20px;">Tap to select a pet to bring to battle!</p>
        <div class="pets-grid" id="petsGrid">
            <!-- Pets populated by JS -->
        </div>
    </div>
    
    <!-- Tower Screen -->
    <div id="towerScreen">
        <div class="inventory-header">
            <h2 class="inventory-title">üè∞ Magic Tower</h2>
            <button class="close-btn" onclick="closeTower()">Close</button>
        </div>
        <p style="color: #888; margin-bottom: 20px;">Climb the tower to earn rewards and rare pets!</p>
        <div class="tower-floors" id="towerFloors">
            <!-- Floors populated by JS -->
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        const gameState = {
            // Player Stats
            level: 1,
            exp: 0,
            expToNext: 100,
            gold: 500,
            gems: 100,
            
            // Combat Stats
            maxHp: 100,
            currentHp: 100,
            maxMp: 100,
            currentMp: 100,
            
            // Base Stats
            stats: {
                INT: 10,  // Magic damage
                WIS: 10,  // Max MP
                VIT: 10,  // Max HP
                SPD: 10,  // Cast speed
                LUK: 10   // Capture rate, gold drop
            },
            statPoints: 0,
            
            // Game Progress
            score: 0,
            wave: 1,
            kills: 0,
            towerFloor: 1,
            highestFloor: 1,
            
            // Equipment
            equippedStaff: 'starter',
            equippedSkills: ['fireball', 'waterBolt', 'rockThrow', 'windSlash'],
            selectedSkill: 0,
            
            // Inventory
            staffs: ['starter'],
            items: {
                mpPotion: 5,
                hpPotion: 5,
                captureOrb: 10
            },
            materials: {},
            
            // Pets
            pets: [],
            activePet: null,
            
            // Settings
            fov: 90,
            sensitivity: 1.0,
            sfxVolume: 0.8,
            musicVolume: 0.5,
            
            // Session
            sessionGold: 0,
            sessionExp: 0,
            
            // Boosts
            expBoostEnd: 0,
            goldBoostEnd: 0
        };
        
        // ==================== ELEMENT SYSTEM ====================
        const elements = {
            fire: { name: 'Fire', icon: 'üî•', color: '#ff5722', beats: 'wind', weakTo: 'water' },
            water: { name: 'Water', icon: 'üíß', color: '#2196f3', beats: 'fire', weakTo: 'earth' },
            earth: { name: 'Earth', icon: 'üåç', color: '#8d6e63', beats: 'water', weakTo: 'wind' },
            wind: { name: 'Wind', icon: 'üí®', color: '#4caf50', beats: 'earth', weakTo: 'fire' },
            light: { name: 'Light', icon: '‚ú®', color: '#ffc107', beats: 'dark', weakTo: 'dark' },
            dark: { name: 'Dark', icon: 'üåô', color: '#9c27b0', beats: 'light', weakTo: 'light' }
        };
        
        function getElementAdvantage(attackElement, defenseElement) {
            const attacker = elements[attackElement];
            if (attacker.beats === defenseElement) return 1.5;
            if (attacker.weakTo === defenseElement) return 0.5;
            return 1.0;
        }
        
        // ==================== SKILLS SYSTEM ====================
        const allSkills = {
            // Fire Skills
            fireball: { name: 'Fireball', element: 'fire', icon: 'üî•', damage: 1.0, mp: 10, cooldown: 0, unlockLevel: 1 },
            flameBurst: { name: 'Flame Burst', element: 'fire', icon: 'üí•', damage: 1.5, mp: 20, cooldown: 3, unlockLevel: 5 },
            inferno: { name: 'Inferno', element: 'fire', icon: 'üåã', damage: 2.0, mp: 35, cooldown: 5, unlockLevel: 10 },
            phoenixStrike: { name: 'Phoenix Strike', element: 'fire', icon: 'ü¶Ö', damage: 3.0, mp: 50, cooldown: 8, unlockLevel: 20 },
            meteorStorm: { name: 'Meteor Storm', element: 'fire', icon: '‚òÑÔ∏è', damage: 4.0, mp: 70, cooldown: 12, unlockLevel: 30 },
            
            // Water Skills
            waterBolt: { name: 'Water Bolt', element: 'water', icon: 'üíß', damage: 1.0, mp: 10, cooldown: 0, unlockLevel: 1 },
            tidalWave: { name: 'Tidal Wave', element: 'water', icon: 'üåä', damage: 1.5, mp: 20, cooldown: 3, unlockLevel: 5 },
            iceStorm: { name: 'Ice Storm', element: 'water', icon: '‚ùÑÔ∏è', damage: 2.0, mp: 35, cooldown: 5, unlockLevel: 10 },
            tsunami: { name: 'Tsunami', element: 'water', icon: 'üåÄ', damage: 3.0, mp: 50, cooldown: 8, unlockLevel: 20 },
            absoluteZero: { name: 'Absolute Zero', element: 'water', icon: 'üßä', damage: 4.0, mp: 70, cooldown: 12, unlockLevel: 30 },
            
            // Earth Skills
            rockThrow: { name: 'Rock Throw', element: 'earth', icon: 'ü™®', damage: 1.0, mp: 10, cooldown: 0, unlockLevel: 1 },
            earthquake: { name: 'Earthquake', element: 'earth', icon: 'üåç', damage: 1.5, mp: 20, cooldown: 3, unlockLevel: 5 },
            boulderCrush: { name: 'Boulder Crush', element: 'earth', icon: '‚õ∞Ô∏è', damage: 2.0, mp: 35, cooldown: 5, unlockLevel: 10 },
            terraForce: { name: 'Terra Force', element: 'earth', icon: 'üèîÔ∏è', damage: 3.0, mp: 50, cooldown: 8, unlockLevel: 20 },
            continentalCrush: { name: 'Continental', element: 'earth', icon: 'üåè', damage: 4.0, mp: 70, cooldown: 12, unlockLevel: 30 },
            
            // Wind Skills
            windSlash: { name: 'Wind Slash', element: 'wind', icon: 'üí®', damage: 1.0, mp: 10, cooldown: 0, unlockLevel: 1 },
            gustBlade: { name: 'Gust Blade', element: 'wind', icon: 'üçÉ', damage: 1.5, mp: 20, cooldown: 3, unlockLevel: 5 },
            cyclone: { name: 'Cyclone', element: 'wind', icon: 'üå™Ô∏è', damage: 2.0, mp: 35, cooldown: 5, unlockLevel: 10 },
            hurricane: { name: 'Hurricane', element: 'wind', icon: 'üåÄ', damage: 3.0, mp: 50, cooldown: 8, unlockLevel: 20 },
            tempestFury: { name: 'Tempest Fury', element: 'wind', icon: '‚ö°', damage: 4.0, mp: 70, cooldown: 12, unlockLevel: 30 },
            
            // Light Skills
            lightRay: { name: 'Light Ray', element: 'light', icon: '‚ú®', damage: 1.0, mp: 10, cooldown: 0, unlockLevel: 1 },
            holyBeam: { name: 'Holy Beam', element: 'light', icon: 'üåü', damage: 1.5, mp: 20, cooldown: 3, unlockLevel: 5 },
            divineFlash: { name: 'Divine Flash', element: 'light', icon: 'üí´', damage: 2.0, mp: 35, cooldown: 5, unlockLevel: 10 },
            judgment: { name: 'Judgment', element: 'light', icon: '‚öñÔ∏è', damage: 3.0, mp: 50, cooldown: 8, unlockLevel: 20 },
            supernova: { name: 'Supernova', element: 'light', icon: 'üåû', damage: 4.0, mp: 70, cooldown: 12, unlockLevel: 30 },
            
            // Dark Skills
            shadowBolt: { name: 'Shadow Bolt', element: 'dark', icon: 'üåô', damage: 1.0, mp: 10, cooldown: 0, unlockLevel: 1 },
            darkPulse: { name: 'Dark Pulse', element: 'dark', icon: 'üñ§', damage: 1.5, mp: 20, cooldown: 3, unlockLevel: 5 },
            voidStrike: { name: 'Void Strike', element: 'dark', icon: 'üï≥Ô∏è', damage: 2.0, mp: 35, cooldown: 5, unlockLevel: 10 },
            nightmare: { name: 'Nightmare', element: 'dark', icon: 'üëÅÔ∏è', damage: 3.0, mp: 50, cooldown: 8, unlockLevel: 20 },
            oblivion: { name: 'Oblivion', element: 'dark', icon: 'üíÄ', damage: 4.0, mp: 70, cooldown: 12, unlockLevel: 30 }
        };
        
        const skillCooldowns = {};
        
        // ==================== MONSTERS ====================
        const monsterTypes = {
            // Fire Monsters (using _t.png for transparent background)
            fireSlime: { name: 'Flamey', element: 'fire', hp: 30, atk: 8, exp: 15, goldMin: 5, goldMax: 15, image: 'fire_slime_t.png' },
            fireDragon: { name: 'Blaze Dragon', element: 'fire', hp: 50, atk: 12, exp: 25, goldMin: 10, goldMax: 25, image: 'fire_slime_t.png' },
            
            // Water Monsters
            waterSpirit: { name: 'Droplet', element: 'water', hp: 30, atk: 8, exp: 15, goldMin: 5, goldMax: 15, image: 'water_spirit_t.png' },
            iceSerpent: { name: 'Frost Serpent', element: 'water', hp: 50, atk: 12, exp: 25, goldMin: 10, goldMax: 25, image: 'water_spirit_t.png' },
            
            // Earth Monsters
            earthGolem: { name: 'Rocky', element: 'earth', hp: 40, atk: 6, exp: 15, goldMin: 5, goldMax: 15, image: 'earth_golem_t.png' },
            stoneGiant: { name: 'Stone Giant', element: 'earth', hp: 60, atk: 10, exp: 25, goldMin: 10, goldMax: 25, image: 'earth_golem_t.png' },
            
            // Wind Monsters
            windFairy: { name: 'Breezy', element: 'wind', hp: 25, atk: 10, exp: 15, goldMin: 5, goldMax: 15, image: 'wind_fairy_t.png' },
            thunderBird: { name: 'Thunder Bird', element: 'wind', hp: 45, atk: 14, exp: 25, goldMin: 10, goldMax: 25, image: 'wind_fairy_t.png' },
            
            // Light Monsters
            lightAngel: { name: 'Sparkle', element: 'light', hp: 35, atk: 9, exp: 20, goldMin: 8, goldMax: 20, image: 'light_angel_t.png' },
            lightUnicorn: { name: 'Radiant Unicorn', element: 'light', hp: 55, atk: 13, exp: 30, goldMin: 12, goldMax: 30, image: 'light_angel_t.png' },
            
            // Dark Monsters
            darkShadow: { name: 'Shadow', element: 'dark', hp: 35, atk: 11, exp: 20, goldMin: 8, goldMax: 20, image: 'dark_shadow_t.png' },
            shadowDemon: { name: 'Shadow Demon', element: 'dark', hp: 55, atk: 15, exp: 30, goldMin: 12, goldMax: 30, image: 'dark_shadow_t.png' }
        };
        
        const bossTypes = {
            fireKing: { name: 'Inferno King', element: 'fire', hp: 500, atk: 25, exp: 200, goldMin: 100, goldMax: 200, image: 'boss_fire_king_t.png', scale: 2.0 },
            iceQueen: { name: 'Frost Queen', element: 'water', hp: 500, atk: 25, exp: 200, goldMin: 100, goldMax: 200, image: 'boss_ice_queen_t.png', scale: 2.0 },
            darkLord: { name: 'Dark Lord', element: 'dark', hp: 600, atk: 30, exp: 300, goldMin: 150, goldMax: 300, image: 'boss_dark_lord_t.png', scale: 2.0 }
        };
        
        // ==================== STAFFS ====================
        const staffData = {
            starter: { name: 'Apprentice Staff', element: 'neutral', damage: 1.0, mp: 0, image: 'staff_starter_t.png', rarity: 'common' },
            fire: { name: 'Flame Staff', element: 'fire', damage: 1.2, mp: 10, image: 'staff_fire_t.png', rarity: 'rare' },
            ice: { name: 'Frost Staff', element: 'water', damage: 1.2, mp: 10, image: 'staff_ice_t.png', rarity: 'rare' },
            nature: { name: 'Nature Staff', element: 'earth', damage: 1.2, mp: 10, image: 'staff_earth_t.png', rarity: 'rare' },
            lightning: { name: 'Storm Staff', element: 'wind', damage: 1.2, mp: 10, image: 'staff_wind_t.png', rarity: 'rare' },
            light: { name: 'Holy Staff', element: 'light', damage: 1.3, mp: 15, image: 'staff_light_t.png', rarity: 'epic' },
            dark: { name: 'Shadow Staff', element: 'dark', damage: 1.3, mp: 15, image: 'staff_dark_t.png', rarity: 'epic' }
        };
        
        // ==================== TOWER FLOORS ====================
        const towerFloors = [
            { floor: 1, name: 'Fire Chamber', element: 'fire', reward: '100 Gold', monsters: ['fireSlime'] },
            { floor: 2, name: 'Water Depths', element: 'water', reward: '150 Gold', monsters: ['waterSpirit'] },
            { floor: 3, name: 'Earth Cavern', element: 'earth', reward: '200 Gold', monsters: ['earthGolem'] },
            { floor: 4, name: 'Wind Peak', element: 'wind', reward: 'Pet Egg', monsters: ['windFairy'] },
            { floor: 5, name: 'Light Sanctuary', element: 'light', reward: '300 Gold', monsters: ['lightAngel'] },
            { floor: 6, name: 'Dark Abyss', element: 'dark', reward: '350 Gold', monsters: ['darkShadow'] },
            { floor: 7, name: 'Dragon\'s Lair', element: 'fire', reward: 'Rare Pet Egg', monsters: ['fireDragon'], boss: 'fireKing' },
            { floor: 8, name: 'Frozen Throne', element: 'water', reward: '500 Gold', monsters: ['iceSerpent'], boss: 'iceQueen' },
            { floor: 9, name: 'Shadow Realm', element: 'dark', reward: '750 Gold', monsters: ['shadowDemon'] },
            { floor: 10, name: 'Final Gate', element: 'dark', reward: 'Legendary Pet', monsters: ['shadowDemon'], boss: 'darkLord' }
        ];
        
        // ==================== GAME VARIABLES ====================
        let canvas, ctx, radarCanvas, radarCtx;
        let monsters = [];
        let spellEffects = [];
        let isPlaying = false;
        let isTowerMode = false;
        let currentTowerFloor = 1;
        
        // Camera/AR
        let cameraHeading = 0;
        let initialAlpha = null;
        let lastAlpha = 0;
        
        // Monster images cache
        const monsterImages = {};
        const staffImages = {};
        
        // ==================== INITIALIZATION ====================
        function init() {
            loadGameState();
            updateMenuDisplay();
            preloadImages();
        }
        
        function preloadImages() {
            // Preload monster images
            Object.values(monsterTypes).forEach(m => {
                const img = new Image();
                img.src = `assets/monsters/${m.image}`;
                monsterImages[m.image] = img;
            });
            Object.values(bossTypes).forEach(m => {
                const img = new Image();
                img.src = `assets/monsters/${m.image}`;
                monsterImages[m.image] = img;
            });
            // Preload staff images
            Object.values(staffData).forEach(s => {
                const img = new Image();
                img.src = `assets/weapons/${s.image}`;
                staffImages[s.image] = img;
            });
        }
        
        function loadGameState() {
            const saved = localStorage.getItem('fantasyMageV4');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(gameState, data);
            }
            // Calculate derived stats
            gameState.maxHp = 100 + (gameState.stats.VIT - 10) * 5;
            gameState.maxMp = 100 + (gameState.stats.WIS - 10) * 5;
            gameState.currentHp = gameState.maxHp;
            gameState.currentMp = gameState.maxMp;
        }
        
        function saveGameState() {
            localStorage.setItem('fantasyMageV4', JSON.stringify(gameState));
        }
        
        function updateMenuDisplay() {
            document.getElementById('menuGold').textContent = gameState.gold.toLocaleString();
            document.getElementById('menuGems').textContent = gameState.gems.toLocaleString();
            document.getElementById('menuLevel').textContent = gameState.level;
            document.getElementById('menuExp').textContent = `${gameState.exp}/${gameState.expToNext}`;
            document.getElementById('menuPets').textContent = gameState.pets.length;
        }
        
        // ==================== GAME START ====================
        async function startAdventure() {
            isTowerMode = false;
            await startGame();
        }
        
        async function startTowerFloor(floor) {
            if (floor > gameState.highestFloor) return;
            isTowerMode = true;
            currentTowerFloor = floor;
            closeTower();
            await startGame();
        }
        
        async function startGame() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            radarCanvas = document.getElementById('radarCanvas');
            radarCtx = radarCanvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Reset game state
            gameState.currentHp = gameState.maxHp;
            gameState.currentMp = gameState.maxMp;
            gameState.wave = 1;
            gameState.score = 0;
            gameState.kills = 0;
            gameState.sessionGold = 0;
            gameState.sessionExp = 0;
            monsters = [];
            spellEffects = [];
            
            // Setup skill bar
            setupSkillBar();
            
            // Update staff display
            updateStaffDisplay();
            
            // Update HUD
            updateHUD();
            
            // Update Potion UI
            updatePotionUI();
            
            // Start camera
            await startCamera();
            
            // Start device orientation
            startDeviceOrientation();
            
            // Spawn initial monsters
            spawnWave();
            
            // Start game loop
            isPlaying = true;
            gameLoop();
        }
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            radarCanvas.width = 100;
            radarCanvas.height = 100;
        }
        
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                document.getElementById('cameraFeed').srcObject = stream;
            } catch (e) {
                console.log('Camera not available');
            }
        }
        
        function startDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    });
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        
        function handleOrientation(event) {
            if (event.alpha === null) return;
            
            if (initialAlpha === null) {
                initialAlpha = event.alpha;
            }
            
            // Calculate heading - FIXED: Now turns correct direction
            let heading = initialAlpha - event.alpha;
            
            // Apply sensitivity
            heading *= gameState.sensitivity;
            
            // Normalize to 0-360
            while (heading < 0) heading += 360;
            while (heading >= 360) heading -= 360;
            
            cameraHeading = heading;
        }
        
        // ==================== SKILL BAR ====================
        function setupSkillBar() {
            const skillBar = document.getElementById('skillBar');
            skillBar.innerHTML = '';
            
            gameState.equippedSkills.forEach((skillId, index) => {
                const skill = allSkills[skillId];
                if (!skill) return;
                
                const btn = document.createElement('div');
                btn.className = `skill-btn ${skill.element} ${index === gameState.selectedSkill ? 'selected' : ''}`;
                btn.innerHTML = `
                    <span class="skill-icon">${skill.icon}</span>
                    <span class="skill-name">${skill.name.split(' ')[0]}</span>
                    <div class="cooldown-overlay" id="cd_${skillId}"></div>
                `;
                btn.onclick = () => selectSkill(index);
                skillBar.appendChild(btn);
            });
        }
        
        function selectSkill(index) {
            gameState.selectedSkill = index;
            document.querySelectorAll('.skill-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
        }
        
        function updateStaffDisplay() {
            const staff = staffData[gameState.equippedStaff];
            document.getElementById('staffImage').src = `assets/weapons/${staff.image}`;
        }
        
        // ==================== MONSTER SPAWNING ====================
        function spawnWave() {
            const monsterCount = isTowerMode ? 3 + currentTowerFloor : 3 + Math.floor(gameState.wave / 2);
            
            for (let i = 0; i < monsterCount; i++) {
                setTimeout(() => spawnMonster(), i * 500);
            }
            
            // Spawn boss on certain waves/floors
            if (isTowerMode) {
                const floorData = towerFloors[currentTowerFloor - 1];
                if (floorData.boss) {
                    setTimeout(() => spawnBoss(floorData.boss), monsterCount * 500 + 1000);
                }
            } else if (gameState.wave % 5 === 0) {
                const bossKeys = Object.keys(bossTypes);
                const randomBoss = bossKeys[Math.floor(Math.random() * bossKeys.length)];
                setTimeout(() => spawnBoss(randomBoss), monsterCount * 500 + 1000);
            }
        }
        
        function spawnMonster() {
            let monsterPool;
            
            if (isTowerMode) {
                const floorData = towerFloors[currentTowerFloor - 1];
                monsterPool = floorData.monsters;
            } else {
                monsterPool = Object.keys(monsterTypes);
            }
            
            const typeKey = monsterPool[Math.floor(Math.random() * monsterPool.length)];
            const type = monsterTypes[typeKey];
            
            // Scale monster stats by player level and wave
            const levelScale = 1 + (gameState.level - 1) * 0.15;
            const waveScale = 1 + (gameState.wave - 1) * 0.1;
            
            // Spawn in front of player (easier to find)
            let angle;
            const rand = Math.random();
            if (rand < 0.6) {
                // 60% spawn in front
                angle = cameraHeading + (Math.random() - 0.5) * 60;
            } else if (rand < 0.8) {
                // 20% spawn left
                angle = cameraHeading - 60 - Math.random() * 60;
            } else {
                // 20% spawn right
                angle = cameraHeading + 60 + Math.random() * 60;
            }
            
            while (angle < 0) angle += 360;
            while (angle >= 360) angle -= 360;
            
            const distance = 12 + Math.random() * 8;
            
            const monster = {
                id: Date.now() + Math.random(),
                type: typeKey,
                name: type.name,
                element: type.element,
                maxHp: Math.floor(type.hp * levelScale * waveScale),
                hp: Math.floor(type.hp * levelScale * waveScale),
                atk: Math.floor(type.atk * levelScale * waveScale),
                exp: Math.floor(type.exp * levelScale),
                goldMin: Math.floor(type.goldMin * waveScale),
                goldMax: Math.floor(type.goldMax * waveScale),
                image: type.image,
                angle: angle,
                distance: distance,
                scale: 1.0,
                attackCooldown: 0,
                animFrame: 0,
                isBoss: false
            };
            
            monsters.push(monster);
        }
        
        function spawnBoss(bossKey) {
            const type = bossTypes[bossKey];
            
            const levelScale = 1 + (gameState.level - 1) * 0.2;
            
            const boss = {
                id: Date.now() + Math.random(),
                type: bossKey,
                name: type.name,
                element: type.element,
                maxHp: Math.floor(type.hp * levelScale),
                hp: Math.floor(type.hp * levelScale),
                atk: Math.floor(type.atk * levelScale),
                exp: type.exp,
                goldMin: type.goldMin,
                goldMax: type.goldMax,
                image: type.image,
                angle: cameraHeading,
                distance: 15,
                scale: type.scale,
                attackCooldown: 0,
                animFrame: 0,
                isBoss: true
            };
            
            monsters.push(boss);
        }
        
        // ==================== GAME LOOP ====================
        function gameLoop() {
            if (!isPlaying) return;
            
            update();
            render();
            renderRadar();
            
            requestAnimationFrame(gameLoop);
        }
        
        function update() {
            const now = Date.now();
            
            // Update monsters
            monsters.forEach(monster => {
                // Move towards player
                if (monster.distance > 2) {
                    monster.distance -= 0.02 * (monster.isBoss ? 0.5 : 1);
                }
                
                // Monster attack
                if (monster.distance <= 3 && monster.attackCooldown <= 0) {
                    playerTakeDamage(monster.atk);
                    monster.attackCooldown = 60; // 1 second at 60fps
                }
                
                if (monster.attackCooldown > 0) {
                    monster.attackCooldown--;
                }
                
                // Animation
                monster.animFrame = (monster.animFrame + 0.1) % 2;
            });
            
            // Update spell effects
            spellEffects = spellEffects.filter(effect => {
                effect.life--;
                effect.x += effect.vx || 0;
                effect.y += effect.vy || 0;
                effect.scale = (effect.scale || 1) * 0.98;
                return effect.life > 0;
            });
            
            // Check capture availability
            const weakMonster = monsters.find(m => m.hp / m.maxHp <= 0.3 && !m.isBoss);
            const captureBtn = document.getElementById('captureBtn');
            if (weakMonster) {
                captureBtn.classList.add('show');
            } else {
                captureBtn.classList.remove('show');
            }
            
            // Check wave completion
            if (monsters.length === 0) {
                gameState.wave++;
                document.getElementById('waveDisplay').textContent = `Wave ${gameState.wave}`;
                spawnWave();
            }
            
            // MP regeneration
            if (gameState.currentMp < gameState.maxMp) {
                gameState.currentMp = Math.min(gameState.maxMp, gameState.currentMp + 0.1);
                updateHUD();
            }
            
            // Update skill cooldowns
            Object.keys(skillCooldowns).forEach(skillId => {
                if (skillCooldowns[skillId] > 0) {
                    skillCooldowns[skillId]--;
                    const cdOverlay = document.getElementById(`cd_${skillId}`);
                    if (cdOverlay) {
                        if (skillCooldowns[skillId] > 0) {
                            cdOverlay.style.display = 'flex';
                            cdOverlay.textContent = Math.ceil(skillCooldowns[skillId] / 60);
                        } else {
                            cdOverlay.style.display = 'none';
                        }
                    }
                }
            });
        }
        
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Render monsters
            monsters.forEach(monster => {
                // Calculate screen position based on angle difference
                let angleDiff = monster.angle - cameraHeading;
                while (angleDiff > 180) angleDiff -= 360;
                while (angleDiff < -180) angleDiff += 360;
                
                // Check if in view (FOV)
                const halfFov = gameState.fov / 2;
                if (Math.abs(angleDiff) > halfFov) return;
                
                // Calculate screen X position
                const screenX = canvas.width / 2 + (angleDiff / halfFov) * (canvas.width / 2);
                
                // Calculate screen Y and size based on distance
                const distanceFactor = Math.max(0.3, 1 - (monster.distance - 2) / 20);
                const baseSize = monster.isBoss ? 250 : 150;
                const size = baseSize * distanceFactor * monster.scale;
                const screenY = canvas.height * 0.5 + (1 - distanceFactor) * 100;
                
                // Draw monster
                const img = monsterImages[monster.image];
                if (img && img.complete) {
                    // Bobbing animation
                    const bob = Math.sin(Date.now() / 200 + monster.id) * 5;
                    ctx.drawImage(img, screenX - size/2, screenY - size/2 + bob, size, size);
                } else {
                    // Fallback circle
                    ctx.fillStyle = elements[monster.element].color;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, size/2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Draw HP bar
                const hpBarWidth = size * 0.8;
                const hpBarHeight = 8;
                const hpBarY = screenY - size/2 - 20;
                
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(screenX - hpBarWidth/2, hpBarY, hpBarWidth, hpBarHeight);
                
                const hpPercent = monster.hp / monster.maxHp;
                ctx.fillStyle = hpPercent > 0.3 ? '#4caf50' : '#f44336';
                ctx.fillRect(screenX - hpBarWidth/2, hpBarY, hpBarWidth * hpPercent, hpBarHeight);
                
                // Draw element icon
                ctx.font = '20px Arial';
                ctx.fillText(elements[monster.element].icon, screenX - 10, hpBarY - 5);
                
                // Draw "WEAK" indicator
                if (hpPercent <= 0.3 && !monster.isBoss) {
                    ctx.fillStyle = '#ff9800';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üîÆ WEAK!', screenX, hpBarY - 25);
                    ctx.textAlign = 'left';
                }
                
                // Draw distance
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${monster.distance.toFixed(0)}m`, screenX, screenY + size/2 + 20);
                ctx.textAlign = 'left';
            });
            
            // Render spell effects
            spellEffects.forEach(effect => {
                ctx.save();
                ctx.globalAlpha = effect.life / effect.maxLife;
                ctx.font = `${30 * (effect.scale || 1)}px Arial`;
                ctx.fillText(effect.icon, effect.x, effect.y);
                ctx.restore();
            });
            
            // Draw crosshair
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            ctx.strokeStyle = 'rgba(255,255,255,0.8)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(centerX - 40, centerY);
            ctx.lineTo(centerX - 20, centerY);
            ctx.moveTo(centerX + 20, centerY);
            ctx.lineTo(centerX + 40, centerY);
            ctx.moveTo(centerX, centerY - 40);
            ctx.lineTo(centerX, centerY - 20);
            ctx.moveTo(centerX, centerY + 20);
            ctx.lineTo(centerX, centerY + 40);
            ctx.stroke();
        }
        
        function renderRadar() {
            radarCtx.clearRect(0, 0, 100, 100);
            
            // Draw radar background
            radarCtx.fillStyle = 'rgba(0,0,0,0.5)';
            radarCtx.beginPath();
            radarCtx.arc(50, 50, 48, 0, Math.PI * 2);
            radarCtx.fill();
            
            // Draw player (center)
            radarCtx.fillStyle = '#7c4dff';
            radarCtx.beginPath();
            radarCtx.arc(50, 50, 5, 0, Math.PI * 2);
            radarCtx.fill();
            
            // Draw direction indicator
            radarCtx.strokeStyle = '#7c4dff';
            radarCtx.lineWidth = 2;
            radarCtx.beginPath();
            radarCtx.moveTo(50, 50);
            radarCtx.lineTo(50, 35);
            radarCtx.stroke();
            
            // Draw monsters
            monsters.forEach(monster => {
                let angleDiff = monster.angle - cameraHeading;
                const angleRad = (angleDiff - 90) * Math.PI / 180;
                const dist = Math.min(monster.distance / 25, 1) * 40;
                
                const x = 50 + Math.cos(angleRad) * dist;
                const y = 50 + Math.sin(angleRad) * dist;
                
                radarCtx.fillStyle = monster.isBoss ? '#f44336' : elements[monster.element].color;
                radarCtx.beginPath();
                radarCtx.arc(x, y, monster.isBoss ? 6 : 4, 0, Math.PI * 2);
                radarCtx.fill();
            });
        }
        
        // ==================== COMBAT ====================
        function castSpell() {
            const skillId = gameState.equippedSkills[gameState.selectedSkill];
            const skill = allSkills[skillId];
            
            if (!skill) return;
            
            // Check cooldown
            if (skillCooldowns[skillId] > 0) return;
            
            // Check MP
            if (gameState.currentMp < skill.mp) {
                showFloatingText('Not enough MP!', canvas.width/2, canvas.height/2, '#2196f3');
                return;
            }
            
            // Use MP
            gameState.currentMp -= skill.mp;
            
            // Set cooldown
            if (skill.cooldown > 0) {
                skillCooldowns[skillId] = skill.cooldown * 60;
            }
            
            // Create spell effect
            createSpellEffect(skill);
            
            // Find target
            const target = findTarget();
            
            if (target) {
                // Calculate damage
                const baseDamage = 20 * skill.damage;
                const intBonus = gameState.stats.INT * 2;
                const staffBonus = staffData[gameState.equippedStaff].damage;
                const elementMult = getElementAdvantage(skill.element, target.element);
                
                let totalDamage = Math.floor((baseDamage + intBonus) * staffBonus * elementMult);
                
                // Show element advantage
                if (elementMult > 1) {
                    showElementAdvantage(true);
                    totalDamage = Math.floor(totalDamage * 1.2); // Extra bonus
                } else if (elementMult < 1) {
                    showElementAdvantage(false);
                }
                
                // Apply damage
                target.hp -= totalDamage;
                
                // Show damage number
                const angleDiff = target.angle - cameraHeading;
                const screenX = canvas.width / 2 + (angleDiff / (gameState.fov/2)) * (canvas.width / 2);
                showFloatingText(`-${totalDamage}`, screenX, canvas.height * 0.4, elements[skill.element].color);
                
                // Check if dead
                if (target.hp <= 0) {
                    killMonster(target);
                }
            }
            
            updateHUD();
        }
        
        function findTarget() {
            let bestTarget = null;
            let bestScore = -Infinity;
            
            monsters.forEach(monster => {
                let angleDiff = monster.angle - cameraHeading;
                while (angleDiff > 180) angleDiff -= 360;
                while (angleDiff < -180) angleDiff += 360;
                
                // Wide hit detection
                const hitAngle = 45 + gameState.stats.LUK;
                if (Math.abs(angleDiff) <= hitAngle) {
                    // Score based on distance and angle
                    const score = (1 / monster.distance) * (1 - Math.abs(angleDiff) / hitAngle);
                    if (score > bestScore) {
                        bestScore = score;
                        bestTarget = monster;
                    }
                }
            });
            
            return bestTarget;
        }
        
        function createSpellEffect(skill) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Create multiple particles based on skill
            const particleCount = skill.damage >= 3 ? 10 : skill.damage >= 2 ? 6 : 3;
            
            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * 2 / particleCount) * i + Math.random() * 0.5;
                const speed = 5 + Math.random() * 5;
                
                spellEffects.push({
                    icon: skill.icon,
                    x: centerX,
                    y: centerY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 2,
                    life: 30,
                    maxLife: 30,
                    scale: 1 + skill.damage * 0.3
                });
            }
        }
        
        function showElementAdvantage(isSuper) {
            const elem = document.getElementById('elementAdvantage');
            elem.className = `element-advantage ${isSuper ? 'advantage-super' : 'advantage-weak'}`;
            elem.textContent = isSuper ? '‚ú® SUPER EFFECTIVE!' : 'üòì Not very effective...';
            elem.style.display = 'block';
            
            setTimeout(() => {
                elem.style.display = 'none';
            }, 1500);
        }
        
        function killMonster(monster) {
            // Calculate rewards
            const goldDrop = Math.floor(
                monster.goldMin + Math.random() * (monster.goldMax - monster.goldMin)
            );
            const goldBonus = Date.now() < gameState.goldBoostEnd ? 2 : 1;
            const finalGold = Math.floor(goldDrop * goldBonus * (1 + gameState.stats.LUK * 0.02));
            
            const expBonus = Date.now() < gameState.expBoostEnd ? 2 : 1;
            const finalExp = Math.floor(monster.exp * expBonus);
            
            // Add rewards
            gameState.gold += finalGold;
            gameState.sessionGold += finalGold;
            gameState.exp += finalExp;
            gameState.sessionExp += finalExp;
            gameState.score += monster.isBoss ? 500 : 100;
            gameState.kills++;
            
            // Dungeon material drop
            if (currentDungeon) {
                const dropChance = 0.3 + (gameState.stats.LUK * 0.01); // 30% base + LUK bonus
                if (Math.random() < dropChance) {
                    const materialId = currentDungeon.id + '_material';
                    gameState.materials = gameState.materials || {};
                    gameState.materials[materialId] = (gameState.materials[materialId] || 0) + 1;
                    
                    // Show material drop
                    const angleDiff2 = monster.angle - cameraHeading;
                    const screenX2 = canvas.width / 2 + (angleDiff2 / (gameState.fov/2)) * (canvas.width / 2);
                    showFloatingText('+1 ' + currentDungeon.reward, screenX2, canvas.height * 0.4, '#00ff00');
                }
            }
            
            // Show gold drop
            const angleDiff = monster.angle - cameraHeading;
            const screenX = canvas.width / 2 + (angleDiff / (gameState.fov/2)) * (canvas.width / 2);
            showGoldDrop(screenX, canvas.height * 0.5, finalGold);
            
            // Remove monster
            monsters = monsters.filter(m => m.id !== monster.id);
            
            // Check level up
            checkLevelUp();
            
            // Update displays
            updateHUD();
            saveGameState();
        }
        
        function showGoldDrop(x, y, amount) {
            const elem = document.createElement('div');
            elem.className = 'gold-drop';
            elem.textContent = `+${amount} ü™ô`;
            elem.style.left = `${x}px`;
            elem.style.top = `${y}px`;
            document.getElementById('gameScreen').appendChild(elem);
            
            setTimeout(() => elem.remove(), 1000);
        }
        
        function showFloatingText(text, x, y, color) {
            const elem = document.createElement('div');
            elem.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                color: ${color};
                font-size: 24px;
                font-weight: bold;
                text-shadow: 2px 2px 4px black;
                pointer-events: none;
                z-index: 230;
                animation: goldFloat 1s forwards;
            `;
            elem.textContent = text;
            document.getElementById('gameScreen').appendChild(elem);
            
            setTimeout(() => elem.remove(), 1000);
        }
        
        function playerTakeDamage(damage) {
            const defense = gameState.stats.VIT * 0.5;
            const finalDamage = Math.max(1, Math.floor(damage - defense));
            
            gameState.currentHp -= finalDamage;
            
            // Flash red
            const flash = document.getElementById('damageFlash');
            flash.style.display = 'block';
            setTimeout(() => flash.style.display = 'none', 100);
            
            // Show damage
            showFloatingText(`-${finalDamage}`, canvas.width/2, canvas.height/2 - 50, '#f44336');
            
            updateHUD();
            
            // Check death
            if (gameState.currentHp <= 0) {
                gameOver();
            }
        }
        
        // ==================== CAPTURE SYSTEM ====================
        function captureMonster() {
            const weakMonster = monsters.find(m => m.hp / m.maxHp <= 0.3 && !m.isBoss);
            if (!weakMonster) return;
            
            if (gameState.items.captureOrb <= 0) {
                showFloatingText('No Capture Orbs!', canvas.width/2, canvas.height/2, '#ff9800');
                return;
            }
            
            // Show capture popup
            document.getElementById('captureMonsterName').textContent = `${elements[weakMonster.element].icon} ${weakMonster.name}`;
            document.getElementById('capturePopup').style.display = 'block';
            document.getElementById('capturePopup').dataset.monsterId = weakMonster.id;
        }
        
        function confirmCapture() {
            const monsterId = parseFloat(document.getElementById('capturePopup').dataset.monsterId);
            const monster = monsters.find(m => m.id === monsterId);
            
            if (!monster) {
                document.getElementById('capturePopup').style.display = 'none';
                return;
            }
            
            // Use capture orb
            gameState.items.captureOrb--;
            
            // Calculate capture chance
            const baseChance = 50;
            const hpBonus = (1 - monster.hp / monster.maxHp) * 30;
            const lukBonus = gameState.stats.LUK * 2;
            const captureChance = Math.min(95, baseChance + hpBonus + lukBonus);
            
            if (Math.random() * 100 < captureChance) {
                // Success!
                const pet = {
                    id: Date.now(),
                    type: monster.type,
                    name: monster.name,
                    element: monster.element,
                    level: 1,
                    exp: 0,
                    image: monster.image
                };
                
                gameState.pets.push(pet);
                monsters = monsters.filter(m => m.id !== monsterId);
                
                showFloatingText(`‚ú® Captured ${monster.name}!`, canvas.width/2, canvas.height/2, '#4caf50');
            } else {
                showFloatingText('Capture failed...', canvas.width/2, canvas.height/2, '#f44336');
            }
            
            document.getElementById('capturePopup').style.display = 'none';
            saveGameState();
        }
        
        // ==================== LEVEL SYSTEM ====================
        function checkLevelUp() {
            while (gameState.exp >= gameState.expToNext) {
                gameState.exp -= gameState.expToNext;
                gameState.level++;
                gameState.expToNext = Math.floor(100 * Math.pow(1.2, gameState.level - 1));
                gameState.statPoints += 5;
                
                // Increase base stats
                gameState.maxHp += 10;
                gameState.maxMp += 5;
                gameState.currentHp = gameState.maxHp;
                gameState.currentMp = gameState.maxMp;
                
                // Show level up popup
                showLevelUp();
            }
        }
        
        function showLevelUp() {
            const popup = document.getElementById('levelUpPopup');
            document.getElementById('newLevel').textContent = gameState.level;
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 2000);
        }
        
        // ==================== HUD ====================
        function updateHUD() {
            // HP Bar
            const hpPercent = (gameState.currentHp / gameState.maxHp) * 100;
            document.getElementById('playerHpBar').style.width = `${hpPercent}%`;
            document.getElementById('playerHpText').textContent = `${Math.floor(gameState.currentHp)}/${gameState.maxHp}`;
            
            // MP Bar
            const mpPercent = (gameState.currentMp / gameState.maxMp) * 100;
            document.getElementById('playerMpBar').style.width = `${mpPercent}%`;
            
            // Currency
            document.getElementById('hudGold').textContent = gameState.gold.toLocaleString();
            document.getElementById('hudGems').textContent = gameState.gems.toLocaleString();
            
            // Score
            document.getElementById('scoreDisplay').textContent = gameState.score.toLocaleString();
            
            // Wave/Floor
            if (isTowerMode) {
                document.getElementById('floorDisplay').style.display = 'block';
                document.getElementById('floorDisplay').textContent = `Floor ${currentTowerFloor}`;
            }
        }
        
        // ==================== GAME OVER ====================
        function gameOver() {
            isPlaying = false;
            
            document.getElementById('finalWave').textContent = gameState.wave;
            document.getElementById('finalKills').textContent = gameState.kills;
            document.getElementById('finalGold').textContent = gameState.sessionGold;
            document.getElementById('finalExp').textContent = gameState.sessionExp;
            
            document.getElementById('gameOverScreen').style.display = 'flex';
            
            saveGameState();
        }
        
        function returnToMenu() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            
            updateMenuDisplay();
        }
        
        function exitGame() {
            isPlaying = false;
            saveGameState();
            returnToMenu();
        }
        
        // ==================== POTIONS ====================
        function useHPPotion() {
            if (gameState.items.hpPotion <= 0) {
                showNotification('No HP Potions!');
                return;
            }
            if (gameState.currentHp >= gameState.maxHp) {
                showNotification('HP is full!');
                return;
            }
            
            gameState.items.hpPotion--;
            gameState.currentHp = Math.min(gameState.maxHp, gameState.currentHp + 50);
            updateHUD();
            updatePotionUI();
            showNotification('+50 HP!');
            saveGameState();
        }
        
        function useMPPotion() {
            if (gameState.items.mpPotion <= 0) {
                showNotification('No MP Potions!');
                return;
            }
            if (gameState.currentMp >= gameState.maxMp) {
                showNotification('MP is full!');
                return;
            }
            
            gameState.items.mpPotion--;
            gameState.currentMp = Math.min(gameState.maxMp, gameState.currentMp + 30);
            updateHUD();
            updatePotionUI();
            showNotification('+30 MP!');
            saveGameState();
        }
        
        function updatePotionUI() {
            const hpCount = document.getElementById('hpPotionCount');
            const mpCount = document.getElementById('mpPotionCount');
            if (hpCount) hpCount.textContent = 'x' + gameState.items.hpPotion;
            if (mpCount) mpCount.textContent = 'x' + gameState.items.mpPotion;
        }
        
        function showNotification(text) {
            // Simple notification - could be improved
            console.log(text);
        }
        
        // ==================== SCREENS ====================
        function showInventory() {
            document.getElementById('inventoryScreen').style.display = 'block';
            showInvTab('weapons');
        }
        
        function closeInventory() {
            document.getElementById('inventoryScreen').style.display = 'none';
        }
        
        function showInvTab(tab) {
            document.querySelectorAll('.inv-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            if (tab === 'weapons') {
                gameState.staffs.forEach(staffId => {
                    const staff = staffData[staffId];
                    const slot = document.createElement('div');
                    slot.className = `inv-slot ${staffId === gameState.equippedStaff ? 'equipped' : ''}`;
                    slot.innerHTML = `
                        <img src="assets/weapons/${staff.image}">
                        <span class="item-name">${staff.name}</span>
                        <span class="item-rarity rarity-${staff.rarity}">${staff.rarity}</span>
                    `;
                    slot.onclick = () => equipStaff(staffId);
                    grid.appendChild(slot);
                });
            } else if (tab === 'items') {
                Object.entries(gameState.items).forEach(([itemId, count]) => {
                    if (count <= 0) return;
                    const icons = { mpPotion: 'üß™', hpPotion: '‚ù§Ô∏è', captureOrb: 'üîÆ' };
                    const names = { mpPotion: 'MP Potion', hpPotion: 'HP Potion', captureOrb: 'Capture Orb' };
                    
                    const slot = document.createElement('div');
                    slot.className = 'inv-slot';
                    slot.innerHTML = `
                        <span style="font-size: 2em">${icons[itemId]}</span>
                        <span class="item-name">${names[itemId]}</span>
                        <span style="color: #ffd700">x${count}</span>
                    `;
                    grid.appendChild(slot);
                });
            } else if (tab === 'materials') {
                const materialNames = {
                    'fire_forge_material': { name: 'Fire Stone', icon: 'üî•' },
                    'water_temple_material': { name: 'Water Crystal', icon: 'üíß' },
                    'earth_cavern_material': { name: 'Earth Gem', icon: 'üåç' },
                    'wind_peak_material': { name: 'Wind Essence', icon: 'üí®' },
                    'light_sanctuary_material': { name: 'Light Orb', icon: '‚ú®' },
                    'dark_abyss_material': { name: 'Dark Shard', icon: 'üåô' }
                };
                
                const materials = gameState.materials || {};
                if (Object.keys(materials).length === 0) {
                    grid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No materials yet! Farm dungeons to collect materials.</p>';
                    return;
                }
                
                Object.entries(materials).forEach(([matId, count]) => {
                    if (count <= 0) return;
                    const mat = materialNames[matId] || { name: matId, icon: 'üíé' };
                    
                    const slot = document.createElement('div');
                    slot.className = 'inv-slot';
                    slot.innerHTML = `
                        <span style="font-size: 2em">${mat.icon}</span>
                        <span class="item-name">${mat.name}</span>
                        <span style="color: #ffd700">x${count}</span>
                    `;
                    grid.appendChild(slot);
                });
            }
        }
        
        function equipStaff(staffId) {
            gameState.equippedStaff = staffId;
            saveGameState();
            showInvTab('weapons');
        }
        
        function showShop() {
            document.getElementById('shopScreen').style.display = 'block';
        }
        
        function closeShop() {
            document.getElementById('shopScreen').style.display = 'none';
        }
        
        // ==================== STATS SCREEN ====================
        function showStats() {
            document.getElementById('statsScreen').style.display = 'block';
            updateStatsUI();
        }
        
        function closeStats() {
            document.getElementById('statsScreen').style.display = 'none';
        }
        
        function updateStatsUI() {
            document.getElementById('availablePoints').textContent = gameState.statPoints;
            document.getElementById('statINT').textContent = gameState.stats.INT;
            document.getElementById('statWIS').textContent = gameState.stats.WIS;
            document.getElementById('statVIT').textContent = gameState.stats.VIT;
            document.getElementById('statSPD').textContent = gameState.stats.SPD;
            document.getElementById('statLUK').textContent = gameState.stats.LUK;
        }
        
        function allocateStat(stat) {
            if (gameState.statPoints <= 0) {
                alert('No stat points available!');
                return;
            }
            
            gameState.statPoints--;
            gameState.stats[stat]++;
            
            // Apply stat effects
            if (stat === 'VIT') {
                gameState.maxHp += 5;
            } else if (stat === 'WIS') {
                gameState.maxMp += 3;
            }
            
            saveGameState();
            updateStatsUI();
            updateMenuUI();
        }
        
        function closeLevelUp() {
            document.getElementById('levelUpPopup').style.display = 'none';
        }
        
        function buyItem(itemId, cost) {
            if (gameState.gold < cost) {
                alert('Not enough Gold!');
                return;
            }
            gameState.gold -= cost;
            gameState.items[itemId] = (gameState.items[itemId] || 0) + 1;
            saveGameState();
            updateMenuDisplay();
            alert(`Purchased ${itemId}!`);
        }
        
        function buyWithGems(itemId, cost) {
            if (gameState.gems < cost) {
                alert('Not enough Gems!');
                return;
            }
            gameState.gems -= cost;
            
            if (itemId === 'gold1000') {
                gameState.gold += 1000;
            } else if (itemId === 'expBoost') {
                gameState.expBoostEnd = Date.now() + 3600000;
            } else if (itemId === 'goldBoost') {
                gameState.goldBoostEnd = Date.now() + 3600000;
            } else if (itemId === 'rareEgg') {
                // Random rare pet
                const rareMonsters = ['fireDragon', 'iceSerpent', 'stoneGiant', 'thunderBird'];
                const type = rareMonsters[Math.floor(Math.random() * rareMonsters.length)];
                const monster = monsterTypes[type];
                gameState.pets.push({
                    id: Date.now(),
                    type: type,
                    name: monster.name,
                    element: monster.element,
                    level: 1,
                    exp: 0,
                    image: monster.image
                });
                alert(`You got ${monster.name}!`);
            }
            
            saveGameState();
            updateMenuDisplay();
        }
        
        function showSkills() {
            document.getElementById('skillsScreen').style.display = 'block';
            renderSkillsList();
        }
        
        function closeSkills() {
            document.getElementById('skillsScreen').style.display = 'none';
        }
        
        function renderSkillsList() {
            const container = document.getElementById('skillsList');
            container.innerHTML = '';
            
            const elementOrder = ['fire', 'water', 'earth', 'wind', 'light', 'dark'];
            
            elementOrder.forEach(element => {
                const section = document.createElement('div');
                section.className = 'element-section';
                
                const title = document.createElement('div');
                title.className = 'element-title';
                title.style.color = elements[element].color;
                title.innerHTML = `
                    <span class="element-icon">${elements[element].icon}</span>
                    <span class="element-name">${elements[element].name}</span>
                `;
                section.appendChild(title);
                
                const skillsList = document.createElement('div');
                skillsList.className = 'skills-list';
                
                Object.entries(allSkills).forEach(([skillId, skill]) => {
                    if (skill.element !== element) return;
                    
                    const unlocked = gameState.level >= skill.unlockLevel;
                    const equipped = gameState.equippedSkills.includes(skillId);
                    
                    const card = document.createElement('div');
                    card.className = `skill-card ${unlocked ? 'unlocked' : 'locked'} ${equipped ? 'equipped' : ''}`;
                    card.innerHTML = `
                        <div class="skill-icon">${skill.icon}</div>
                        <div class="skill-name">${skill.name}</div>
                        <div class="skill-dmg">DMG: ${skill.damage}x | MP: ${skill.mp}</div>
                        <div class="skill-unlock">${unlocked ? (equipped ? '‚úì Equipped' : 'Tap to equip') : `Unlock: Lv.${skill.unlockLevel}`}</div>
                    `;
                    
                    if (unlocked) {
                        card.onclick = () => toggleSkillEquip(skillId);
                    }
                    
                    skillsList.appendChild(card);
                });
                
                section.appendChild(skillsList);
                container.appendChild(section);
            });
        }
        
        function toggleSkillEquip(skillId) {
            const index = gameState.equippedSkills.indexOf(skillId);
            if (index >= 0) {
                gameState.equippedSkills.splice(index, 1);
            } else if (gameState.equippedSkills.length < 4) {
                gameState.equippedSkills.push(skillId);
            } else {
                alert('Max 4 skills! Unequip one first.');
                return;
            }
            saveGameState();
            renderSkillsList();
        }
        
        function showSettings() {
            document.getElementById('settingsScreen').style.display = 'block';
            document.getElementById('fovSlider').value = gameState.fov;
            document.getElementById('fovValue').textContent = `${gameState.fov}¬∞`;
            document.getElementById('sensitivitySlider').value = gameState.sensitivity * 100;
            document.getElementById('sensitivityValue').textContent = `${gameState.sensitivity.toFixed(1)}x`;
        }
        
        function closeSettings() {
            document.getElementById('settingsScreen').style.display = 'none';
            saveGameState();
        }
        
        function updateFOV() {
            gameState.fov = parseInt(document.getElementById('fovSlider').value);
            document.getElementById('fovValue').textContent = `${gameState.fov}¬∞`;
        }
        
        function updateSensitivity() {
            gameState.sensitivity = parseInt(document.getElementById('sensitivitySlider').value) / 100;
            document.getElementById('sensitivityValue').textContent = `${gameState.sensitivity.toFixed(1)}x`;
        }
        
        function updateSFX() {
            gameState.sfxVolume = parseInt(document.getElementById('sfxSlider').value) / 100;
            document.getElementById('sfxValue').textContent = `${Math.round(gameState.sfxVolume * 100)}%`;
        }
        
        function updateMusic() {
            gameState.musicVolume = parseInt(document.getElementById('musicSlider').value) / 100;
            document.getElementById('musicValue').textContent = `${Math.round(gameState.musicVolume * 100)}%`;
        }
        
        function showPets() {
            document.getElementById('petsScreen').style.display = 'block';
            renderPetsList();
        }
        
        function closePets() {
            document.getElementById('petsScreen').style.display = 'none';
        }
        
        // ==================== PET CARE (TAMAGOTCHI) ====================
        let selectedCarePet = null;
        
        function showPetCare() {
            document.getElementById('petCareScreen').style.display = 'block';
            renderPetCare();
        }
        
        function closePetCare() {
            document.getElementById('petCareScreen').style.display = 'none';
        }
        
        function renderPetCare() {
            const list = document.getElementById('petCareList');
            list.innerHTML = '';
            
            if (gameState.pets.length === 0) {
                document.getElementById('petCareSelector').textContent = 'No pets yet! Capture monsters first.';
                return;
            }
            
            gameState.pets.forEach(pet => {
                const btn = document.createElement('button');
                btn.style.cssText = 'padding: 10px 15px; border: 2px solid ' + (selectedCarePet === pet.id ? '#fff' : 'transparent') + '; border-radius: 10px; background: rgba(255,255,255,0.3); cursor: pointer;';
                btn.innerHTML = `<img src="assets/monsters/${pet.image}" style="width: 40px; height: 40px;"><br>${pet.name}`;
                btn.onclick = () => selectCarePet(pet.id);
                list.appendChild(btn);
            });
            
            if (selectedCarePet) {
                updatePetCareUI();
            }
        }
        
        function selectCarePet(petId) {
            selectedCarePet = petId;
            renderPetCare();
            updatePetCareUI();
        }
        
        function updatePetCareUI() {
            const pet = gameState.pets.find(p => p.id === selectedCarePet);
            if (!pet) return;
            
            // Initialize pet stats if not exist
            if (pet.hunger === undefined) pet.hunger = 100;
            if (pet.happiness === undefined) pet.happiness = 100;
            if (pet.energy === undefined) pet.energy = 100;
            
            const type = monsterTypes[pet.type];
            document.getElementById('petCareImg').src = `assets/monsters/${pet.image}`;
            document.getElementById('petCareSelector').textContent = pet.name + ' - Lv.' + pet.level;
            
            document.getElementById('hungerFill').style.width = pet.hunger + '%';
            document.getElementById('happinessFill').style.width = pet.happiness + '%';
            document.getElementById('energyFill').style.width = pet.energy + '%';
            
            // Update mood
            const avgStats = (pet.hunger + pet.happiness + pet.energy) / 3;
            let mood = 'üòä';
            if (avgStats < 30) mood = 'üò¢';
            else if (avgStats < 50) mood = 'üòü';
            else if (avgStats < 70) mood = 'üòê';
            else if (avgStats >= 90) mood = 'ü§©';
            document.getElementById('petCareMood').textContent = mood;
        }
        
        function feedPet() {
            if (!selectedCarePet) { alert('Select a pet first!'); return; }
            if (gameState.gold < 10) { alert('Not enough gold!'); return; }
            
            const pet = gameState.pets.find(p => p.id === selectedCarePet);
            if (!pet) return;
            
            gameState.gold -= 10;
            pet.hunger = Math.min(100, (pet.hunger || 0) + 30);
            saveGameState();
            updatePetCareUI();
            updateMenuUI();
        }
        
        function playWithPet() {
            if (!selectedCarePet) { alert('Select a pet first!'); return; }
            
            const pet = gameState.pets.find(p => p.id === selectedCarePet);
            if (!pet) return;
            
            if ((pet.energy || 100) < 20) { alert('Pet is too tired!'); return; }
            
            pet.happiness = Math.min(100, (pet.happiness || 0) + 25);
            pet.energy = Math.max(0, (pet.energy || 100) - 15);
            saveGameState();
            updatePetCareUI();
        }
        
        function restPet() {
            if (!selectedCarePet) { alert('Select a pet first!'); return; }
            
            const pet = gameState.pets.find(p => p.id === selectedCarePet);
            if (!pet) return;
            
            pet.energy = Math.min(100, (pet.energy || 0) + 40);
            saveGameState();
            updatePetCareUI();
        }
        
        function trainPet() {
            if (!selectedCarePet) { alert('Select a pet first!'); return; }
            
            const pet = gameState.pets.find(p => p.id === selectedCarePet);
            if (!pet) return;
            
            if ((pet.energy || 100) < 30) { alert('Pet needs more energy!'); return; }
            
            pet.energy = Math.max(0, (pet.energy || 100) - 25);
            pet.exp = (pet.exp || 0) + 20;
            
            // Level up pet
            const expNeeded = pet.level * 50;
            if (pet.exp >= expNeeded) {
                pet.level++;
                pet.exp = 0;
                alert(pet.name + ' leveled up to Lv.' + pet.level + '!');
            }
            
            saveGameState();
            updatePetCareUI();
        }
        
        // ==================== DUNGEONS ====================
        const dungeons = [
            { id: 'fire_forge', name: 'üî• Fire Forge', desc: 'Farm Fire Stones', element: 'fire', minLevel: 1, reward: 'Fire Stone' },
            { id: 'water_temple', name: 'üíß Water Temple', desc: 'Farm Water Crystals', element: 'water', minLevel: 3, reward: 'Water Crystal' },
            { id: 'earth_cavern', name: 'üåç Earth Cavern', desc: 'Farm Earth Gems', element: 'earth', minLevel: 5, reward: 'Earth Gem' },
            { id: 'wind_peak', name: 'üí® Wind Peak', desc: 'Farm Wind Essence', element: 'wind', minLevel: 7, reward: 'Wind Essence' },
            { id: 'light_sanctuary', name: '‚ú® Light Sanctuary', desc: 'Farm Light Orbs', element: 'light', minLevel: 10, reward: 'Light Orb' },
            { id: 'dark_abyss', name: 'üåô Dark Abyss', desc: 'Farm Dark Shards', element: 'dark', minLevel: 12, reward: 'Dark Shard' }
        ];
        
        function showDungeons() {
            document.getElementById('dungeonScreen').style.display = 'block';
            renderDungeons();
        }
        
        function closeDungeons() {
            document.getElementById('dungeonScreen').style.display = 'none';
        }
        
        function renderDungeons() {
            const list = document.getElementById('dungeonList');
            list.innerHTML = '';
            
            dungeons.forEach(dungeon => {
                const locked = gameState.level < dungeon.minLevel;
                const card = document.createElement('div');
                card.className = 'dungeon-card' + (locked ? ' locked' : '');
                card.innerHTML = `
                    <div class="dungeon-icon">${elements[dungeon.element].icon}</div>
                    <div class="dungeon-info">
                        <div class="dungeon-name">${dungeon.name}</div>
                        <div class="dungeon-desc">${dungeon.desc}</div>
                        <div class="dungeon-reward">üéÅ Reward: ${dungeon.reward}</div>
                        ${locked ? '<div style="color: #f44336;">Requires Lv.' + dungeon.minLevel + '</div>' : ''}
                    </div>
                `;
                if (!locked) {
                    card.onclick = () => enterDungeon(dungeon);
                }
                list.appendChild(card);
            });
        }
        
        function enterDungeon(dungeon) {
            closeDungeons();
            currentDungeon = dungeon;
            startAdventure();
        }
        
        let currentDungeon = null;
        
        function renderPetsList() {
            const grid = document.getElementById('petsGrid');
            grid.innerHTML = '';
            
            if (gameState.pets.length === 0) {
                grid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No pets yet! Capture monsters in Adventure mode.</p>';
                return;
            }
            
            gameState.pets.forEach(pet => {
                const card = document.createElement('div');
                card.className = `pet-card ${gameState.activePet === pet.id ? 'selected' : ''}`;
                card.innerHTML = `
                    <img src="assets/monsters/${pet.image}">
                    <div class="pet-name">${pet.name}</div>
                    <div class="pet-element">${elements[pet.element].icon} ${elements[pet.element].name}</div>
                    <div class="pet-level">Lv. ${pet.level}</div>
                `;
                card.onclick = () => {
                    gameState.activePet = gameState.activePet === pet.id ? null : pet.id;
                    saveGameState();
                    renderPetsList();
                };
                grid.appendChild(card);
            });
        }
        
        function showTower() {
            document.getElementById('towerScreen').style.display = 'block';
            renderTowerFloors();
        }
        
        function closeTower() {
            document.getElementById('towerScreen').style.display = 'none';
        }
        
        function renderTowerFloors() {
            const container = document.getElementById('towerFloors');
            container.innerHTML = '';
            
            towerFloors.forEach((floor, index) => {
                const floorNum = index + 1;
                const cleared = floorNum < gameState.highestFloor;
                const current = floorNum === gameState.highestFloor;
                const locked = floorNum > gameState.highestFloor;
                
                const elem = document.createElement('div');
                elem.className = `tower-floor ${cleared ? 'cleared' : ''} ${current ? 'current' : ''} ${locked ? 'locked' : ''}`;
                elem.innerHTML = `
                    <div class="floor-info">
                        <span class="floor-number">${floorNum}</span>
                        <span class="floor-element">${elements[floor.element].icon}</span>
                        <div>
                            <div class="floor-name">${floor.name}</div>
                            <div class="floor-reward">Reward: ${floor.reward}</div>
                        </div>
                    </div>
                    <span>${cleared ? '‚úì' : (current ? '‚Üí' : 'üîí')}</span>
                `;
                
                if (!locked) {
                    elem.onclick = () => startTowerFloor(floorNum);
                }
                
                container.appendChild(elem);
            });
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
